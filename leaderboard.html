<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./assets/styles/global.css">
    <link rel="icon" type="image/x-icon" href="./assets/images/snake.ico">
    <title>Snake Leaderboard</title>
</head>

<body>
    <div class="scrolling">
        <h1 class="title">
            <span class="icon">üêç</span>Top Agent Snakes<span class="icon">üêç</span>
        </h1>

        <div class="leaderboard-table">
            <header>
                <h1 class="table-title">LEADERBOARD</h1>
                <div class="blur"></div>
            </header>
            <table class="leaderboard">
                <thead>
                    <th class="rank"></th>
                    <th class="username">USERNAME</th>
                    <th class="score">SCORE</th>
                    <th class="date">Date</th>
                </thead>
            </table>
        </div>

        <div class="go-back">
            <button class="go-back-btn">GO BACK</button>
        </div>
    </div>

    <script type="text/javascript">
        // Fetch All Users in Leaderboard
        async function getAllUsers() {
            try {
                const response = await fetch("https://snake.howbout.app/api/onur/high-scores");
                const data = await response.json();

                if (data.length === 0) {
                    // do something
                } else {
                    return data
                }
            } catch (err) {
                console.log(err)
            }
        }

        // Sort Data by Score
        async function getAndSortDataByScore() {
            const data = await getAllUsers();

            data.sort((a, b) => {
                return b.score - a.score
            })

            return data
        }

        // format date into DD-MM-YYYY 
        const formatDate = (date) => {
            let d = new Date(date);
            let month = (d.getMonth() + 1).toString();
            let day = d.getDate().toString();
            let year = d.getFullYear();
            if (month.length < 2) {
                month = '0' + month;
            }
            if (day.length < 2) {
                day = '0' + day;
            }
            return [day, month, year].join('-');
        }

        // Render Data into Leaderboard Table
        async function renderLeaderboard() {
            const data = await getAndSortDataByScore();
            const table = document.querySelector('.leaderboard');

            for (let i = 0; i < data.length; i++) {
                let row = `<tr>
                                <td class="rank">${i + 1}</td>
                                <td class="username">${data[i].name}</td>
                                <td class="score">${data[i].score}</td>
                                <td class="date">${formatDate(data[i].created_at)}</td>
                            </tr>`

                table.innerHTML += row
            }
        }

        renderLeaderboard();

        // Go Back Button
        let goBackBtn = document.querySelector('.go-back-btn');

        goBackBtn.addEventListener('click', () => {
            window.location.href = 'snake.html';
        })

    </script>
</body>

</html>